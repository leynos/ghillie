openapi: 3.1.0
info:
  title: Ghillie Runtime API
  version: 0.1.0
  description: >-
    Minimal HTTP surface for Kubernetes probes. The runtime only exposes
    liveness and readiness endpoints.
servers:
  - url: http://{host}:{port}
    description: Runtime server
    variables:
      host:
        default: localhost
        description: Hostname or IP for the runtime server.
      port:
        default: "8080"
        description: TCP port for the runtime server.
security:
  - ApiKeyAuth: []
tags:
  - name: Health
    description: Kubernetes liveness and readiness probes.
  - name: Reports
    description: On-demand report generation endpoints.
paths:
  /health:
    get:
      summary: Liveness probe
      description: Returns ok when the process is alive.
      tags:
        - Health
      security: []
      responses:
        "200":
          description: Service is alive.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthStatus"
              examples:
                ok:
                  value:
                    status: ok
  /ready:
    get:
      summary: Readiness probe
      description: Returns ready when the service is ready to accept traffic.
      tags:
        - Health
      security: []
      responses:
        "200":
          description: Service is ready.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyStatus"
              examples:
                ready:
                  value:
                    status: ready
  /reports/repositories/{owner}/{name}:
    post:
      summary: Generate on-demand repository report
      description: >-
        Triggers report generation for the specified repository using the
        same pipeline as scheduled reports. The endpoint identifies
        repositories by their GitHub owner/name slug.
      tags:
        - Reports
      parameters:
        - name: owner
          in: path
          required: true
          schema:
            type: string
          description: GitHub repository owner.
          example: acme
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: GitHub repository name.
          example: widgets
      responses:
        "200":
          description: Report generated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReportMetadata"
              examples:
                on_track:
                  value:
                    report_id: abc-123
                    repository: acme/widgets
                    window_start: "2024-07-07T00:00:00+00:00"
                    window_end: "2024-07-14T00:00:00+00:00"
                    generated_at: "2024-07-14T12:00:00+00:00"
                    status: on_track
                    model: mock-v1
        "204":
          description: >-
            Repository exists but no events were found in the current
            reporting window.
        "404":
          description: Repository not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                not_found:
                  value:
                    title: Repository not found
                    description: "No repository matching 'acme/widgets' exists."
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: >-
        Placeholder authentication scheme for future endpoints. Health and
        readiness endpoints explicitly opt out of authentication.
  schemas:
    BaseStatus:
      type: object
      additionalProperties: false
      required:
        - status
      properties:
        status:
          type: string
    HealthStatus:
      allOf:
        - $ref: "#/components/schemas/BaseStatus"
        - type: object
          properties:
            status:
              const: ok
    ReadyStatus:
      allOf:
        - $ref: "#/components/schemas/BaseStatus"
        - type: object
          properties:
            status:
              const: ready
    ReportMetadata:
      type: object
      additionalProperties: false
      required:
        - report_id
        - repository
        - window_start
        - window_end
        - generated_at
        - status
        - model
      properties:
        report_id:
          type: string
          description: Unique identifier for the generated report.
        repository:
          type: string
          description: Repository slug (owner/name).
        window_start:
          type: string
          format: date-time
          description: Start of the reporting window (inclusive).
        window_end:
          type: string
          format: date-time
          description: End of the reporting window (exclusive).
        generated_at:
          type: string
          format: date-time
          description: Timestamp when the report was generated.
        status:
          type: string
          description: Repository status from the machine summary.
        model:
          type: string
          description: Identifier of the model that generated the report.
    ErrorResponse:
      type: object
      additionalProperties: false
      required:
        - title
        - description
      properties:
        title:
          type: string
          description: Short error title.
        description:
          type: string
          description: Human-readable error description.
